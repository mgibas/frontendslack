<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="message-bar.html">
<link rel="import" href="message-template.html">

<dom-module id="channel-element">

  <template>
    <style  include="iron-flex iron-flex-alignment iron-flex-factors iron-positioning">
      :host {
        display: block;
      }
      
      app-header {
        background-color: var(--app-primary-color);
        color: #fff;
      }
      
      section {
        height: 100%;
      }
      
      paper-listbox {
        margin-bottom: 80px;
      }
      
      message-bar{
        position:fixed;
        bottom:0;
        right:0;
        width:100%;
      }

    </style>
    
    <firebase-document
      id="fbNewMessage"
      app-name="frontendslack"
      data="{{newMessage}}">
    </firebase-document>
    
    <firebase-document
        id="fbChannel"
        path="channelPath"
        app-name="frontendslack"
        data="{{channel}}"></firebase-document>
           
    <app-header reveals>
        <app-toolbar>
            <paper-icon-button icon="arrow-back" on-tap="_close"></paper-icon-button>
            <div title>
              [[channel.name]]
            </div>
        </app-toolbar>
    </app-header>
    
    <section class="layout vertical">
      <paper-listbox class="flex" id="messageList" >
         <template is="dom-repeat" items="{{getMessages(channel.messages)}}" as="message">
          <message-template
            message="{{message}}"
            current-username="{{username}}">
          </message-template>
        </template>
      </paper-listbox>
      <message-bar on-message-sent="_sendMessage"></message-bar> 
    </section>
  </template>

  <script>
    (() => {
      'use strict';
      class ChannelElement {
        get is() { return 'channel-element'; }
        
        get properties() {
          return {
            route: Object,
            selectedChannel: String,
            username: {
              type: String,
              value: () => `anonymous-${Math.floor(Math.random() * 1000000000)}`
            }
          };
        }

        get observers() {
          return [
            '_keyChanged(selectedChannel)'
          ];
        }
        
        _close(){
          this.fire('close');
        }
        
        _sendMessage(e, data) {
          this.newMessage = {
            author: this.username,
            text: data.message,
            date: new Date().toISOString(),
          }
          this.$.fbNewMessage.save(`/channels/${this.selectedChannel}/messages`)
          this.$.fbNewMessage.reset();
        }
        
        _keyChanged(key) {
          this.$.fbChannel.path = `/channels/${this.selectedChannel}`;
        }
        
        getMessages(channelMessages) {
          return !channelMessages ? [] :
                  Object.keys(channelMessages).map((k) => channelMessages[k]);
        }
        
      }
      
      Polymer(ChannelElement);
    })();
  </script>
</dom-module>